# GameTimeBonus

Плагин для Counter-Strike 2 (CS2) на базе CounterStrikeSharp, который начисляет бонусные деньги игрокам за проведённое время на сервере.

## Возможности

- Автоматическое начисление бонуса игрокам за время игры на сервере
- Интеграция с MySQL базой данных для хранения баланса игроков
- Поддержка мультиязычности (русский, английский, украинский)
- Настраиваемый интервал и сумма бонуса
- Логирование всех операций
- Исключение ботов и HLTV из системы бонусов
- **Заморозка времени при выходе с сервера**
- **Заморозка времени при нахождении в спектаторах**
- **Окно возврата 2 минуты** — игрок может вернуться и сохранить накопленное время
- **Проверка регистрации в ЛК** — игроки без аккаунта не получают награду

## Требования

- Counter-Strike 2
- CounterStrikeSharp
- .NET 8.0
- MySQL сервер

## Установка

1. Скопируйте папку `GameTimeBonus` в директорию:
   ```
   csgo/addons/counterstrikesharp/plugins/
   ```

2. Скопируйте папку `lang` с файлами локализации в:
   ```
   csgo/addons/counterstrikesharp/plugins/GameTimeBonus/lang/
   ```

3. Настройте подключение к базе данных в конфигурационном файле.

4. Перезапустите сервер или загрузите плагин через CounterStrikeSharp.

## Конфигурация

При первом запуске плагин автоматически создаст файл конфигурации `GameTimeBonus.json` в директории:
```
csgo/addons/counterstrikesharp/configs/plugins/GameTimeBonus/
```

### Параметры конфигурации

```json
{
    "Version": 1,
    "Database": {
        "Host": "localhost",
        "Port": 3306,
        "Username": "root",
        "Password": "",
        "Name": "new"
    },
    "Settings": {
        "BonusIntervalSeconds": 600,
        "BonusAmount": 1,
        "EnableLogging": true,
        "Language": "ru",
        "ReturnWindowSeconds": 120
    }
}
```

| Параметр | Описание | Значение по умолчанию |
|----------|----------|----------------------|
| `BonusIntervalSeconds` | Интервал начисления бонуса в секундах | 600 |
| `BonusAmount` | Сумма бонуса | 1 |
| `EnableLogging` | Включить логирование | true |
| `Language` | Язык (ru, en, uk) | ru |
| `ReturnWindowSeconds` | Окно возврата в секундах (2 минуты) | 120 |

## Как работает система начисления

### Таймер накопления времени
- Каждую секунду глобальное время игрока увеличивается
- Если флаг активности `false` — время **не накапливается**
- Когда накопленное время достигает `BonusIntervalSeconds` — выдаётся награда и счётчик сбрасывается

### Флаг активности (`IsActive`)
Флаг активности устанавливается в `false` в случаях:
- Игрок вышел с сервера
- Игрок перешёл в наблюдатели (спектаторы)

При возвращении на сервер:
- Если прошло менее 2 минут — накопленное время сохраняется
- Если прошло более 2 минут — накопленное время сбрасывается

### Проверка регистрации в ЛК
Перед выдачей награды плагин проверяет наличие игрока в базе данных личного кабинета:
- Если игрок **не найден** в таблице `lk` — награда **не выдаётся**
- Если игрок **найден** — награда выдаётся стандартным способом

## База данных

Плагин использует таблицу `lk` со следующей структурой:

```sql
CREATE TABLE IF NOT EXISTS lk (
    id INT AUTO_INCREMENT PRIMARY KEY,
    auth VARCHAR(64) NOT NULL,
    cash DECIMAL(10, 2) DEFAULT 0,
    UNIQUE KEY auth (auth)
);
```

- `auth` - SteamID игрока в формате STEAM_1:0:XXXXX
- `cash` - баланс игрока

## Локализация

Плагин поддерживает следующие языки:
- Русский (ru)
- Английский (en)
- Украинский (uk)

### Файлы локализации

- `lang/ru.json` - Русский
- `lang/en.json` - Английский
- `lang/uk.json` - Украинский

### Настройка сообщения

Измените значение `BonusMessage` в соответствующем файле для настройки сообщения о бонусе:

```json
{
    "BonusMessage": "[Бонус] Вам начислено {amount} руб."
}
```

Где `{amount}` будет заменено на сумму бонуса.

## Логирование

Логи сохраняются в файл:
```
csgo/addons/counterstrikesharp/logs/GameTimeBonus.log
```

Логи содержат информацию о:
- Подключении к базе данных
- Подключении и отключении игроков
- Заморозке/разморозке времени
- Начислении бонусов
- Пропуске игроков (не зарегистрированных в ЛК)
- Ошибках

## Компиляция

Для компиляции плагина выполните:

```batch
cd GameTimeBonus
compile.bat
```

Или вручную:

```bash
dotnet publish -c Release -o ./compile/addons/counterstrikesharp/plugins/GameTimeBonus
```

## Версии

- **Версия плагина**: 1.0.1
- **Версия .NET**: 8.0
- **Зависимости**: 
  - CounterStrikeSharp.API
  - MySqlConnector 2.3.1

## История версий

См. файл [CHANGELOG.md](CHANGELOG.md)

## Автор

- **Автор**: PattHs
- **Версия CounterStrikeSharp API**: 1.0.362

## Лицензия

Указание автора Орегинала.

## Скриншоты

### Консоль сервера
![Console](GameTimeBonus/img/console.png)

### Интерфейс плагина
![Plugin Interface](GameTimeBonus/img/2026-02-20_185404.png)
